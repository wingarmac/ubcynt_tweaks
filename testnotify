#!/bin/bash
#!/bin/bash
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  testnotify â€“ Cinnamon-friendly notification click handler â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Description:
# This script sends a notification using `notify-send` and listens
# for a user click using `dbus-monitor`. If the notification is clicked,
# it opens a styled YAD dialog displaying contextual information.
#
# Designed for Cinnamon or any GTK3 environment where `zenity` might
# cause libadwaita theme warnings. This version ensures full visual
# consistency with Cinnamon themes.
#
# Dependencies:
#   - notify-send (libnotify-bin)
#   - yad
#   - dbus-monitor
#   - coreutils (mktemp, stdbuf, etc.)
#
# Usage:
#   ./testnotify
#
# Output:
#   ğŸ–±ï¸  Clicking the notification opens a detailed popup via YAD.
#   ğŸ§¹ Temporary files are automatically cleaned up.
#
# See also:
#   https://askubuntu.com/questions/1179739/how-to-create-a-notification-in-gnome-from-command-with-onclick-functionality

TMPFILE=$(mktemp /tmp/notify-details-XXXX.txt)

cat <<EOT > "$TMPFILE"
ğŸ“ Detailed Report

The notification was successfully clicked. Action triggered:

â€¢ Status: OK
â€¢ Timestamp: $(date)
â€¢ Script PID: $$

Thank you for using the interactive notifier.
EOT

NOTIFICATION_ID=$(notify-send "Background Task Finished" \
  "A detailed report is ready. Click to open it." \
  --icon="dialog-information" --print-id)

stdbuf -oL awk -v ID="$NOTIFICATION_ID" -v FILE="$TMPFILE" '
  BEGIN { match_id=0 }
  /uint32/ {
    if (match_id==0) {
      notif_id = $2
      match_id=1
    } else {
      reason = $2
      if (notif_id == ID && reason == 2) {
        system("yad --title=\"Detailed Report\" --width=500 --height=250 --text-info --center --filename=" FILE " --button=OK")
        exit 0
      }
      match_id=0
    }
  }' < <(dbus-monitor --session "type='signal',interface='org.freedesktop.Notifications',member='NotificationClosed'")

rm -f "$TMPFILE"
